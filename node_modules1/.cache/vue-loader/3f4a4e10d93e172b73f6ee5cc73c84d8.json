{"remainingRequest":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\src\\views\\project\\contract\\personnelChangeAdd.vue?vue&type=style&index=0&id=2b9f748e&lang=scss&scoped=true&","dependencies":[{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\src\\views\\project\\contract\\personnelChangeAdd.vue","mtime":1684246187999},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\css-loader\\dist\\cjs.js","mtime":1684411443176},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":1684411446724},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\postcss-loader\\src\\index.js","mtime":1684411443221},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\sass-loader\\dist\\cjs.js","mtime":1684411446938},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1684411445150},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\vue-loader\\lib\\index.js","mtime":1684411444634}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQpAaW1wb3J0ICdAL2Fzc2V0cy9jc3Mvc3RlcHMuc2Nzcyc7DQouaW5mbyB7DQogIG92ZXJmbG93OiBhdXRvOw0KICBwLnRpdGxlIHsNCiAgICBmb250LXNpemU6IDE0cHg7DQogICAgcGFkZGluZy1sZWZ0OiAxNXB4Ow0KICB9DQogIC5idG4tY29uIHsNCiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7DQogICAgZGlzcGxheTogZmxleDsNCiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWFyb3VuZDsNCiAgICBwYWRkaW5nOiAxMHB4IDMwcHg7DQogICAgLnZhbi1idXR0b24tLW5vcm1hbCB7DQogICAgICBwYWRkaW5nOiAwcHggNDVweDsNCiAgICB9DQogIH0NCn0NCg=="},{"version":3,"sources":["personnelChangeAdd.vue"],"names":[],"mappings":";AAgUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"personnelChangeAdd.vue","sourceRoot":"src/views/project/contract","sourcesContent":["<template>\r\n  <div :style=\"{ height: scrollerHeight }\" class=\"info\">\r\n    <van-form @submit=\"onSubmit\" :v-model=\"formData\">\r\n      <p class=\"title\">基本信息</p>\r\n      <van-cell-group inset>\r\n        <van-field v-model=\"formData.projectChildName\" label=\"标段\" readonly />\r\n        <van-field v-model=\"formData.recorder\" label=\"填报人\" readonly />\r\n        <van-field v-model=\"formData.subDate\" label=\"填报日期\" readonly />\r\n        <!-- <van-field v-model=\"showTime\" label=\"日期时间\" readonly />\r\n        <van-field v-model=\"formData.clockAddr\" label=\"打卡位置\" readonly /> -->\r\n      </van-cell-group>\r\n      <p class=\"title\">变更信息</p>\r\n      <van-cell-group inset>\r\n        <van-field v-model=\"formData.projectName\" label=\"项目\" readonly />\r\n        <van-field v-model=\"formData.projectChildName\" label=\"标段\" readonly />\r\n        <van-field\r\n          label=\"人员变更类型\"\r\n          v-model=\"formData.changeTypeName\"\r\n          is-link\r\n          readonly\r\n          placeholder=\"请选择\"\r\n          @click=\"showChangeType = true\"\r\n          :rules=\"[{ required: true, message: '请选择人员变更类型' }]\"\r\n          v-if=\"add\"\r\n        />\r\n        <van-field v-else v-model=\"formData.changeTypeName\" label=\"人员变更类型\" readonly />\r\n\r\n        <van-field\r\n          label=\"变更岗位\"\r\n          v-model=\"formData.changePostName\"\r\n          is-link\r\n          disabled\r\n          placeholder=\"请选择\"\r\n          v-if=\"add\"\r\n        />\r\n        <van-field v-else v-model=\"formData.changePostName\" label=\"变更岗位\" readonly />\r\n\r\n        <van-field\r\n          label=\"变更前人员\"\r\n          v-model=\"formData.beforePerson\"\r\n          is-link\r\n          readonly\r\n          placeholder=\"请选择\"\r\n          @click=\"showBeforePerson = true\"\r\n          :rules=\"[{ required: true, message: '请选择变更前人员' }]\"\r\n          v-if=\"add\"\r\n        />\r\n        <van-field v-else v-model=\"formData.beforePerson\" label=\"变更前人员\" readonly />\r\n\r\n        <van-field v-model=\"formData.beforeCode\" label=\"变更前(执业)资格证书号\" :readonly=\"!add\" />\r\n        <van-field\r\n          label=\"变更后人员\"\r\n          v-model=\"formData.afterPerson\"\r\n          is-link\r\n          readonly\r\n          placeholder=\"请选择\"\r\n          @click=\"showAfterPerson = true\"\r\n          :rules=\"[{ required: true, message: '请选择变更后人员' }]\"\r\n          v-if=\"add\"\r\n        />\r\n        <van-field v-else v-model=\"formData.afterPerson\" label=\"变更后人员\" readonly />\r\n\r\n        <van-field v-model=\"formData.afterCode\" label=\"变更后(执业)资格证书号\" :readonly=\"!add\" />\r\n        <van-field v-model=\"formData.changeUnitName\" label=\"变更单位\" readonly />\r\n      </van-cell-group>\r\n      <p class=\"title\">附件</p>\r\n      <van-cell-group inset>\r\n        <upload label=\"文件上传\" :name=\"picFiled\" :fileList=\"fileList\" :editable=\"add\"></upload>\r\n      </van-cell-group>\r\n      <div v-if=\"!add\">\r\n        <p class=\"title\">审批记录</p>\r\n        <van-cell-group inset>\r\n          <van-steps direction=\"vertical\" :active=\"logData.length - 1\">\r\n            <van-step v-for=\"(item, index) in logData\" :key=\"index\">\r\n              <h3>{{ item.taskName }}</h3>\r\n              <p>执行人：{{ item.createName }}</p>\r\n              <p>操作：{{ item.approvalType }}</p>\r\n              <p>审批意见：{{ item.comment }}</p>\r\n              <p>处理时间：{{ item.createTime }}</p>\r\n            </van-step>\r\n          </van-steps>\r\n        </van-cell-group>\r\n      </div>\r\n      <!-- <div v-if=\"add\">\r\n        <approveuser :auditUser=\"auditUser\" :flowKey=\"flowKey\"> </approveuser>\r\n      </div> -->\r\n      <div class=\"btn-con\">\r\n        <!-- <van-button type=\"default\" @click=\"cancel\">取消</van-button> -->\r\n        <van-button type=\"primary\" v-if=\"add\">提交</van-button>\r\n      </div>\r\n    </van-form>\r\n    <van-action-sheet v-model=\"showChangeType\" :actions=\"changeTypeList\" @select=\"onChangeTypeSelect\" />\r\n    <van-action-sheet v-model=\"showBeforePerson\" :actions=\"beforeUsers\" @select=\"onChangeBeforePerson\" />\r\n    <van-action-sheet v-model=\"showAfterPerson\" :actions=\"afterUsers\" @select=\"onChangeAfterPerson\" />\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { mapGetters } from 'vuex'\r\nimport { getNowDate } from '@/utils/date.js'\r\nimport { getRoleInfoByUserId, getUserRoleAndCode, addPersonChange } from '@/api/project'\r\nimport { submitUserTask, listFlowTaskComment } from '@/api/quality'\r\nimport { lookUrl } from '@/utils/index'\r\nimport Upload from '@/components/common/Upload'\r\nimport approveuser from '@/views/common/approveuser.vue'\r\nexport default {\r\n  computed: {\r\n    ...mapGetters(['currentBiaoDuan', 'userinfo', 'curProject']),\r\n    scrollerHeight: function() {\r\n      return window.innerHeight - 85 + 'px'\r\n    }\r\n  },\r\n  components: {\r\n    Upload,\r\n    approveuser\r\n  },\r\n  data() {\r\n    return {\r\n      add: true,\r\n      formData: {},\r\n      showChangeType: false,\r\n      showBeforePerson: false,\r\n      showAfterPerson: false,\r\n      changeTypeList: [], //人员变更类型\r\n      beforeUsers: [], //变更前人员\r\n      afterUsers: [], //变更后人员\r\n\r\n      roleInfoList: [],\r\n\r\n      fileList: [],\r\n      picFiled: 'files',\r\n\r\n      // flowTypes: [\r\n      //   {\r\n      //     key: 'shigongjihe', //施工单位人员变更\r\n      //     flowKey: 'sgdwrybg'\r\n      //   },\r\n      //   {\r\n      //     key: 'jianlijihe', //监理单位合同人员报审\r\n      //     flowKey: 'jldwrybg'\r\n      //   },\r\n      //   {\r\n      //     key: 'quanzijihe', //监理单位合同人员报审\r\n      //     flowKey: 'qzdwrybg'\r\n      //   }\r\n      // ],\r\n      // userRoleParentCode: '',\r\n      logData: [],\r\n      auditUser: {},\r\n      flowKey: ''\r\n    }\r\n  },\r\n  created() {\r\n    if (!this.$route.params.flowKey) {\r\n      this.add = false\r\n      this.fileList = this.formatImgUrl(this.$route.params.files)\r\n      this.formData = Object.assign({}, this.$route.params)\r\n    }\r\n  },\r\n  mounted() {\r\n    if (!this.$route.params.flowKey) {\r\n      this.add = false\r\n      // this.formData = Object.assign({}, this.$route.params)\r\n      this.listFlowTaskComment()\r\n    } else {\r\n      this.flowKey = this.$route.params.flowKey\r\n      this.init()\r\n      this.initForm()\r\n    }\r\n  },\r\n  methods: {\r\n    init() {\r\n      getRoleInfoByUserId({ projectid: this.currentBiaoDuan.id }).then(res => {\r\n        this.roleInfoList = res\r\n        this.changeTypeList = []\r\n        if (res && res.length > 0) {\r\n          let data = JSON.parse(JSON.stringify(res))\r\n          for (let i = 0; i < data.length; i++) {\r\n            for (let j = i + 1; j < data.length; j++) {\r\n              if (data[i].roleid === data[j].roleid) {\r\n                data.splice(j, 1)\r\n                j--\r\n              }\r\n            }\r\n          }\r\n          data.forEach(item => {\r\n            this.changeTypeList.push({\r\n              name: item.rolename,\r\n              roleid: item.roleid\r\n            })\r\n          })\r\n        }\r\n      })\r\n      //获取用户角色\r\n      // getUserRoleAndCode({ projectId: this.currentBiaoDuan.id }).then(res => {\r\n      //   if (res) {\r\n      //     this.userRoleParentCode = res.parentCode\r\n      //   }\r\n      // })\r\n    },\r\n    initForm() {\r\n      this.formData = {\r\n        afterCode: '', //变更后（执业）资格证书号\r\n        afterPerson: '', //变更后人员名\r\n        afterPersonId: null, //变更后人员id\r\n        beforeCode: '', //变更前（执业）资格证书号\r\n        beforePerson: '', //变更前人员名\r\n        beforePersonId: null, //变更前人员id\r\n        changePost: null, //变更岗位id\r\n        changePostName: '', //变更岗位名\r\n        changeReason: '', //变更原因\r\n        changeType: null, //角色id\r\n        changeTypeName: '', //角色名\r\n        changeUnit: this.userinfo.groupid, //组织id\r\n        changeUnitName: this.userinfo.groupname, //组织名\r\n        projectChildId: this.currentBiaoDuan.id, //项目标段id\r\n        projectChildName: this.currentBiaoDuan.name, //项目标段名\r\n        projectId: this.curProject.id, //项目id\r\n        projectName: this.curProject.name, //项目名\r\n        recordId: this.userinfo.id, //变更发起人id\r\n        recorder: this.userinfo.name, //变更发起人名\r\n        subDate: getNowDate() //变更发起时间\r\n      }\r\n    },\r\n    onChangeTypeSelect(item) {\r\n      this.showChangeType = false\r\n      this.formData.changeType = item.roleid\r\n      this.formData.changeTypeName = item.name\r\n\r\n      this.formData.changePost = item.roleid //变更岗位id\r\n      this.formData.changePostName = item.name //变更岗位名\r\n\r\n      this.beforeUsers = this.roleInfoList.filter(e => e.roleid === item.roleid)\r\n      this.afterUsers = this.roleInfoList.filter(e => e.roleid !== item.roleid)\r\n\r\n      this.formData.beforePerson = ''\r\n      this.formData.beforePersonId = null\r\n      this.formData.afterPerson = ''\r\n      this.formData.afterPersonId = null\r\n    },\r\n    onChangeBeforePerson(item) {\r\n      this.showBeforePerson = false\r\n      this.formData.beforePerson = item.name\r\n      this.formData.beforePersonId = item.id\r\n    },\r\n    onChangeAfterPerson(item) {\r\n      this.showAfterPerson = false\r\n      this.formData.afterPerson = item.name\r\n      this.formData.afterPersonId = item.id\r\n    },\r\n    onSubmit(values) {\r\n      // if (!this.userRoleParentCode) {\r\n      //   return this.$notify({ type: 'warning', message: '配置错误、无法获取审批流程，请联系管理员！' })\r\n      // }\r\n      // let flowObj = this.flowTypes.find(e => e.key === this.userRoleParentCode)\r\n      // if (!flowObj) {\r\n      //   return this.$notify({ type: 'warning', message: '配置错误、无法获取审批流程，请联系管理员！' })\r\n      // }\r\n      let temp = []\r\n      values[this.picFiled].forEach(item => {\r\n        item.url &&\r\n          temp.push({\r\n            fileName: item.file.name,\r\n            fileId: item.url,\r\n            uploadPerson: this.userinfo.name,\r\n            uploadPersonId: this.userinfo.id,\r\n            uploadTime: this.moment(new Date()).format('YYYY-MM-DD HH:mm:SS')\r\n          })\r\n      })\r\n\r\n      if (values[this.picFiled].length !== temp.length) {\r\n        return this.$notify({ type: 'warning', message: '请上传照片或等待照片上传完成！' })\r\n      }\r\n      let obj = Object.assign({}, this.formData)\r\n      if (temp.length > 0) {\r\n        obj.files = temp\r\n      }\r\n      obj.processDefinitionKey = this.flowKey\r\n      console.log(obj)\r\n      addPersonChange(obj).then(res => {\r\n        this.issueStep(res)\r\n      })\r\n    },\r\n    issueStep(data) {\r\n      let obj = {\r\n        copyData: {},\r\n        flowTaskCommentDto: {\r\n          approvalType: '',\r\n          comment: '',\r\n          delegateAssginee: ''\r\n        },\r\n        masterData: {},\r\n        processInstanceId: data,\r\n        slaveData: {},\r\n        taskId: '',\r\n        taskVariableData: {}\r\n      }\r\n      submitUserTask(obj).then(res1 => {\r\n        this.$router.go(-1)\r\n        return this.$notify({ type: 'success', message: '填报成功！' })\r\n      })\r\n    },\r\n    listFlowTaskComment() {\r\n      listFlowTaskComment({ processInstanceId: this.$route.params.processInstanceId }).then(res => {\r\n        this.logData = res.data\r\n      })\r\n    },\r\n    formatImgUrl(arr) {\r\n      let urls = []\r\n      arr &&\r\n        arr.forEach(item => {\r\n          urls.push({ url: lookUrl(item.fileId), isImage: true })\r\n        })\r\n      return urls\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n@import '@/assets/css/steps.scss';\r\n.info {\r\n  overflow: auto;\r\n  p.title {\r\n    font-size: 14px;\r\n    padding-left: 15px;\r\n  }\r\n  .btn-con {\r\n    text-align: center;\r\n    display: flex;\r\n    justify-content: space-around;\r\n    padding: 10px 30px;\r\n    .van-button--normal {\r\n      padding: 0px 45px;\r\n    }\r\n  }\r\n}\r\n</style>\r\n"]}]}