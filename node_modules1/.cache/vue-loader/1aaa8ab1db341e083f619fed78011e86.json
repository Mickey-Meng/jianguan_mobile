{"remainingRequest":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\src\\views\\project\\contract\\takeVacationAdd.vue?vue&type=style&index=0&id=c82dec60&lang=scss&scoped=true&","dependencies":[{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\src\\views\\project\\contract\\takeVacationAdd.vue","mtime":1684246188002},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\css-loader\\dist\\cjs.js","mtime":1684411443176},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":1684411446724},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\postcss-loader\\src\\index.js","mtime":1684411443221},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\sass-loader\\dist\\cjs.js","mtime":1684411446938},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1684411445150},{"path":"E:\\Workspace\\JianGuan\\jianguan_mobile\\mobile\\node_modules\\vue-loader\\lib\\index.js","mtime":1684411444634}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQpAaW1wb3J0ICdAL2Fzc2V0cy9jc3Mvc3RlcHMuc2Nzcyc7DQouaW5mbyB7DQogIG92ZXJmbG93OiBhdXRvOw0KICAuaGVhZCB7DQogICAgaGVpZ2h0OiAzNnB4Ow0KICAgIGxpbmUtaGVpZ2h0OiAzNnB4Ow0KICAgIHBhZGRpbmc6IDAgMjBweDsNCiAgICAub3BlcmF0ZSB7DQogICAgICBmbG9hdDogcmlnaHQ7DQogICAgICBtYXJnaW4tdG9wOiA1cHg7DQogICAgICB3aWR0aDogODBweDsNCiAgICB9DQogIH0NCiAgLnRpdGxlIHsNCiAgICBtYXJnaW4tbGVmdDogMjBweDsNCiAgfQ0KICAuYnRuLWNvbiB7DQogICAgdGV4dC1hbGlnbjogY2VudGVyOw0KICAgIGRpc3BsYXk6IGZsZXg7DQogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1hcm91bmQ7DQogICAgcGFkZGluZzogMTBweCAzMHB4Ow0KICAgIC52YW4tYnV0dG9uLS1ub3JtYWwgew0KICAgICAgcGFkZGluZzogMHB4IDQ1cHg7DQogICAgfQ0KICB9DQp9DQo="},{"version":3,"sources":["takeVacationAdd.vue"],"names":[],"mappings":";AA6UA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"takeVacationAdd.vue","sourceRoot":"src/views/project/contract","sourcesContent":["<template>\r\n  <div :style=\"{ height: scrollerHeight }\" class=\"info\">\r\n    <van-form @submit=\"onSubmit\" :v-model=\"formData\">\r\n      <div class=\"head\">\r\n        <span>基本信息</span>\r\n        <van-button class=\"operate\" type=\"primary\" size=\"mini\" v-if=\"add\">提交</van-button>\r\n      </div>\r\n      <van-cell-group inset>\r\n        <van-field v-model=\"formData.leaverPersonName\" label=\"请假人\" readonly />\r\n        <van-field\r\n          label=\"请假类型\"\r\n          v-model=\"formData.leaverType\"\r\n          is-link\r\n          readonly\r\n          placeholder=\"请选择\"\r\n          @click=\"showLeaverType = true\"\r\n          v-if=\"add\"\r\n        />\r\n        <van-field v-else v-model=\"formData.leaverType\" label=\"请假类型\" readonly />\r\n        <van-field\r\n          v-model=\"formData.startTime\"\r\n          is-link\r\n          readonly\r\n          name=\"calendar\"\r\n          label=\"开始时间\"\r\n          placeholder=\"点击选择日期\"\r\n          @click=\"showBeginPicker = true\"\r\n          :rules=\"[{ required: true, message: '请选择开始时间' }]\"\r\n          v-if=\"add\"\r\n        />\r\n        <van-field v-else v-model=\"formData.startTime\" label=\"开始时间\" readonly />\r\n\r\n        <van-field\r\n          v-model=\"formData.endTime\"\r\n          is-link\r\n          readonly\r\n          name=\"calendar\"\r\n          label=\"结束时间\"\r\n          placeholder=\"点击选择日期\"\r\n          @click=\"showEndPicker = true\"\r\n          :rules=\"[{ required: true, message: '请选择结束时间' }]\"\r\n          v-if=\"add\"\r\n        />\r\n        <van-field v-else v-model=\"formData.endTime\" label=\"结束时间\" readonly />\r\n\r\n        <van-field v-model=\"formData.leaveDay\" label=\"请假天数\" readonly />\r\n        <van-field\r\n          label=\"工作交接人\"\r\n          v-model=\"formData.handoffPerson\"\r\n          is-link\r\n          readonly\r\n          placeholder=\"请选择\"\r\n          @click=\"showhandoffPerson = true\"\r\n          v-if=\"add\"\r\n        />\r\n        <van-field v-else v-model=\"formData.handoffPerson\" label=\"工作交接人\" readonly />\r\n        <van-field\r\n          v-model=\"formData.leaveReason\"\r\n          label=\"请假原因\"\r\n          :readonly=\"!add\"\r\n          :rules=\"[{ required: true, message: '请输入请假原因' }]\"\r\n        />\r\n        <van-field v-model=\"formData.remark\" label=\"备注\" :readonly=\"!add\" />\r\n      </van-cell-group>\r\n      <!-- <div v-if=\"add\">\r\n        <approveuser :auditUser=\"auditUser\" :flowKey=\"flowKey\"> </approveuser>\r\n      </div> -->\r\n      <!-- <div class=\"btn-con\">\r\n        <van-button type=\"primary\" v-if=\"add\">提交</van-button>\r\n      </div> -->\r\n    </van-form>\r\n    <flowStep :flowTypes=\"flowTypes\" :step=\"flowStep\"></flowStep>\r\n    <div v-if=\"!add\">\r\n      <p class=\"title\">审批记录</p>\r\n      <van-cell-group inset>\r\n        <van-steps direction=\"vertical\" :active=\"logData.length - 1\">\r\n          <van-step v-for=\"(item, index) in logData\" :key=\"index\">\r\n            <h3>{{ item.taskName }}</h3>\r\n            <p>执行人：{{ item.createName }}</p>\r\n            <p>操作：{{ item.approvalType }}</p>\r\n            <p>审批意见：{{ item.comment }}</p>\r\n            <p>处理时间：{{ item.createTime }}</p>\r\n          </van-step>\r\n        </van-steps>\r\n      </van-cell-group>\r\n    </div>\r\n    <van-action-sheet v-model=\"showLeaverType\" :actions=\"eventType\" @select=\"onLeaverTypeSelect\" />\r\n    <van-action-sheet v-model=\"showhandoffPerson\" :actions=\"handoffPerson\" @select=\"onhandoffPersonSelect\" />\r\n    <van-popup v-model=\"showBeginPicker\" position=\"bottom\">\r\n      <van-datetime-picker\r\n        v-model=\"currentDate\"\r\n        type=\"datetime\"\r\n        @confirm=\"beginConfirm\"\r\n        @cancel=\"showBeginPicker = false\"\r\n      />\r\n    </van-popup>\r\n    <van-popup v-model=\"showEndPicker\" position=\"bottom\">\r\n      <van-datetime-picker\r\n        v-model=\"currentDate\"\r\n        type=\"datetime\"\r\n        @confirm=\"endConfirm\"\r\n        @cancel=\"showEndPicker = false\"\r\n      />\r\n    </van-popup>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { mapGetters } from 'vuex'\r\nimport { getDic } from '@/api/userauth'\r\nimport { getRoleInfoByUserId, getUserRoleAndCode, submitLeave } from '@/api/project'\r\nimport { getFlowAuditEntry, submitUserTask, listFlowTaskComment } from '@/api/quality'\r\nimport { diff, getTotal, getNowDate } from '@/utils/date'\r\nimport { formatISO8601Time } from '@/utils/index'\r\nimport approveuser from '@/views/common/approveuser.vue'\r\nimport flowStep from '@/views/common/flowStep.vue'\r\nexport default {\r\n  computed: {\r\n    ...mapGetters(['userinfo', 'currentBiaoDuan', 'curProject']),\r\n    scrollerHeight() {\r\n      return window.innerHeight - 85 + 'px'\r\n    }\r\n  },\r\n  components: {\r\n    approveuser,\r\n    flowStep\r\n  },\r\n  data() {\r\n    return {\r\n      add: true,\r\n      formData: [],\r\n      handoffPerson: [], //工作交接可选人\r\n      eventType: [],\r\n      userRoleParentCode: '',\r\n      flowTypes: [\r\n        {\r\n          key: 'shigongjihe', //施工单位人员请假\r\n          flowKey: 'sgdwryqj'\r\n        },\r\n        {\r\n          key: 'jianlijihe', //监理单位人员请假\r\n          flowKey: 'jldwryqj'\r\n        },\r\n        {\r\n          key: 'quanzijihe', //全咨单位人员请假\r\n          flowKey: 'qzdwryqj'\r\n        }\r\n      ],\r\n      showLeaverType: false,\r\n      showhandoffPerson: false,\r\n      currentDate: new Date(),\r\n      showBeginPicker: false,\r\n      showEndPicker: false,\r\n\r\n      logData: [],\r\n\r\n      auditUser: {},\r\n\r\n      workTime: {\r\n        startWorkTime: 8.5, //上班时间\r\n        endWorkTime: 18, //下班时间\r\n        startFreeTime: 12, //午休开始时间\r\n        endFreeTime: 13.5, //午休结束时间\r\n        excludeFreeTime: true, //是否去除午休时间\r\n        excludeDates: [] //剔除日期数组\r\n      },\r\n      flowKey: '',\r\n      flowStep: 0\r\n    }\r\n  },\r\n  mounted() {\r\n    console.log(this.$route.params)\r\n    if (this.$route.params.flowKey) {\r\n      this.flowKey = this.$route.params.flowKey\r\n      this.init()\r\n    } else {\r\n      this.add = false\r\n      this.formData = Object.assign({}, this.$route.params)\r\n      this.listFlowTaskComment()\r\n    }\r\n  },\r\n  methods: {\r\n    init() {\r\n      getDic('qjlx').then(data => {\r\n        this.eventType = data.qjlx\r\n      })\r\n      getRoleInfoByUserId({ projectid: this.currentBiaoDuan.id }).then(data => {\r\n        this.handoffPerson = data.filter(e => e.id !== this.userinfo.id)\r\n      })\r\n      //获取用户角色\r\n      // getUserRoleAndCode({ projectId: this.currentBiaoDuan.id }).then(data => {\r\n      //   if (data) {\r\n      //     this.userRoleParentCode = data.parentCode\r\n      //   }\r\n      // })\r\n      this.initForm()\r\n    },\r\n    initForm() {\r\n      this.formData = {\r\n        startTime: '', //开始时间\r\n        endTime: '', //结束时间\r\n        handoffPerson: '', //工作交接人\r\n        handoffPersonId: null, //交接人ID\r\n        leaveDay: null, //请假天数\r\n        leavePersonId: this.userinfo.id, //leavePersonId\r\n        leaverPersonName: this.userinfo.name, //leaverPersonName\r\n        leaveReason: '', //leaveReason\r\n        leaverType: '', //请假类型id\r\n        projectId: this.currentBiaoDuan.id, //项目id\r\n        remark: '', //备注\r\n        subDate: '' //填报时间\r\n      }\r\n    },\r\n    onLeaverTypeSelect(item) {\r\n      this.showLeaverType = false\r\n      this.formData.leaverType = item.name\r\n    },\r\n    onhandoffPersonSelect(item) {\r\n      this.showhandoffPerson = false\r\n      this.formData.handoffPerson = item.name\r\n      this.formData.handoffPersonId = item.id\r\n    },\r\n    beginConfirm(time) {\r\n      this.showBeginPicker = false\r\n      this.formData.startTime = formatISO8601Time(new Date(time).toJSON())\r\n      this.calcLeaveDay()\r\n    },\r\n    endConfirm(time) {\r\n      this.showEndPicker = false\r\n      this.formData.endTime = formatISO8601Time(new Date(time).toJSON())\r\n      this.calcLeaveDay()\r\n    },\r\n    // 计算请假天数\r\n    calcLeaveDay() {\r\n      if (this.formData.startTime !== '' && this.formData.endTime !== '') {\r\n        let h = diff(this.formData.endTime, this.formData.startTime) //时间差\r\n        if (h <= 0) {\r\n          this.formData.endTime = ''\r\n          return this.$notify({ type: 'warning', message: '结束时间需大于开始时间!' })\r\n        }\r\n        let obj = Object.assign({}, this.workTime)\r\n        obj.beginAt = this.formData.startTime\r\n        obj.endAt = this.formData.endTime\r\n        let leaveHours = getTotal(obj)\r\n\r\n        let wholeWorkTime =\r\n          this.workTime.startFreeTime -\r\n          this.workTime.startWorkTime +\r\n          this.workTime.endWorkTime -\r\n          this.workTime.endFreeTime\r\n        // console.log(\"上班总时长：\"+wholeWorkTime);\r\n        let day = leaveHours / wholeWorkTime\r\n        let arrDay = day.toString().split('.')\r\n        if (arrDay[0] > 0) {\r\n          let xs = day - arrDay[0]\r\n          // xs =parseFloat('0.'+xs)\r\n          if (xs > 0 && xs < 0.5) {\r\n            day = parseInt(arrDay[0]) + 0.5\r\n          } else if (xs > 0.5) {\r\n            day = parseInt(arrDay[0]) + 1\r\n          }\r\n        } else {\r\n          if (day > 0 && day < 0.5) {\r\n            day = 0.5\r\n          } else if (day > 0.5) {\r\n            day = 1\r\n          }\r\n        }\r\n        this.formData.leaveDay = day + ''\r\n      }\r\n    },\r\n    onSubmit() {\r\n      // if (!this.userRoleParentCode) {\r\n      //   return this.$notify({ type: 'warning', message: '配置错误、无法获取审批流程，请联系管理员！' })\r\n      // }\r\n      // let flowObj = this.flowTypes.find(e => e.key === this.userRoleParentCode)\r\n      // if (!flowObj) {\r\n      //   return this.$notify({ type: 'warning', message: '配置错误、无法获取审批流程，请联系管理员！' })\r\n      // }\r\n      let obj = Object.assign({}, this.formData)\r\n      obj.subDate = getNowDate()\r\n      obj.processDefinitionKey = this.flowKey\r\n      submitLeave(obj).then(data => {\r\n        this.issueStep(data)\r\n      })\r\n    },\r\n    issueStep(params) {\r\n      getFlowAuditEntry({\r\n        flowKey: this.flowKey,\r\n        buildSection: this.currentBiaoDuan.id,\r\n        projectId: this.curProject.id\r\n      }).then(res => {\r\n        let arr = []\r\n        let { data } = res\r\n        for (let i in data) {\r\n          arr = arr.concat(data[i])\r\n        }\r\n        let userMap = {}\r\n        arr.forEach(item => {\r\n          let value = item.entryUserVariable\r\n          userMap[value] = item.userNames.toString()\r\n        })\r\n        userMap.startUserName = this.userinfo.name\r\n        let obj = {\r\n          copyData: {},\r\n          flowTaskCommentDto: {\r\n            approvalType: '',\r\n            comment: '',\r\n            delegateAssginee: ''\r\n          },\r\n          masterData: {},\r\n          processInstanceId: params,\r\n          slaveData: {},\r\n          taskId: '',\r\n          taskVariableData: userMap\r\n        }\r\n        submitUserTask(obj).then(res1 => {\r\n          this.$router.go(-1)\r\n          return this.$notify({ type: 'success', message: '填报成功！' })\r\n        })\r\n      })\r\n    },\r\n    listFlowTaskComment() {\r\n      listFlowTaskComment({ processInstanceId: this.$route.params.processInstanceId }).then(res => {\r\n        this.logData = res.data\r\n        this.flowStep = this.logData.length > 0 ? this.logData.length - 1 : 0\r\n      })\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n@import '@/assets/css/steps.scss';\r\n.info {\r\n  overflow: auto;\r\n  .head {\r\n    height: 36px;\r\n    line-height: 36px;\r\n    padding: 0 20px;\r\n    .operate {\r\n      float: right;\r\n      margin-top: 5px;\r\n      width: 80px;\r\n    }\r\n  }\r\n  .title {\r\n    margin-left: 20px;\r\n  }\r\n  .btn-con {\r\n    text-align: center;\r\n    display: flex;\r\n    justify-content: space-around;\r\n    padding: 10px 30px;\r\n    .van-button--normal {\r\n      padding: 0px 45px;\r\n    }\r\n  }\r\n}\r\n</style>\r\n"]}]}